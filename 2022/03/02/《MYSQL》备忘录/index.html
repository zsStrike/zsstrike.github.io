<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;zh-HK&quot;,&quot;zh-TW&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>《MYSQL》备忘录 | zsStrike</title><meta name="keywords" content="MySQL"><meta name="author" content="zsStrike"><meta name="copyright" content="zsStrike"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="用于整理 MySQL 的相关知识，以备查询。">
<meta property="og:type" content="article">
<meta property="og:title" content="《MYSQL》备忘录">
<meta property="og:url" content="http://zsstrike.github.io/2022/03/02/%E3%80%8AMYSQL%E3%80%8B%E5%A4%87%E5%BF%98%E5%BD%95/index.html">
<meta property="og:site_name" content="zsStrike">
<meta property="og:description" content="用于整理 MySQL 的相关知识，以备查询。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://zsstrike.github.io/assets/default_cover.png">
<meta property="article:published_time" content="2022-03-02T06:17:22.000Z">
<meta property="article:modified_time" content="2022-05-16T07:41:46.165Z">
<meta property="article:author" content="zsStrike">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://zsstrike.github.io/assets/default_cover.png"><link rel="shortcut icon" href="/assets/avatar.jpg"><link rel="canonical" href="http://zsstrike.github.io/2022/03/02/%E3%80%8AMYSQL%E3%80%8B%E5%A4%87%E5%BF%98%E5%BD%95/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":5000,"languages":{"author":"作者: zsStrike","link":"链接: ","source":"来源: zsStrike","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '《MYSQL》备忘录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-16 15:41:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/avatar.jpg" onerror="onerror=null;src='/assets/default_cover.png'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/index"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">zsStrike</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/index"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">《MYSQL》备忘录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-02T06:17:22.000Z" title="发表于 2022-03-02 14:17:22">2022-03-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-05-16T07:41:46.165Z" title="更新于 2022-05-16 15:41:46">2022-05-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="《MYSQL》备忘录"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><p>用于整理 MySQL 的相关知识，以备查询。</p>
<span id="more"></span>



<h2 id="01-MySQL-概览"><a href="#01-MySQL-概览" class="headerlink" title="01 MySQL 概览"></a>01 MySQL 概览</h2><p>存储引擎：</p>
<ul>
<li>InnoDB：支持事务，支持行级锁，支持外键，采用 MVCC 支持高并发，支持四个隔离级别</li>
<li>MyISAM：不支持事务，只支持表锁，支持压缩表和空间数据索引，数据恢复困难</li>
</ul>
<p>索引数据结构：</p>
<ul>
<li>AVL 树：左右子树树高相差不超过 1 的平衡二叉树，插入和删除会引入旋转操作，适合查找多的场景</li>
<li>红黑树：确保没有一条路径会比其他路径长 2 倍，近似平衡，适合插入删除操作多的场景</li>
<li>跳表：平均性能和红黑树相当，但实现更为简单</li>
<li>B 树：多路查找树，中间节点也会携带实际数据</li>
<li>B+ 树：多路查找树，只有叶子节点才会携带实际数据，查询性能稳定</li>
</ul>
<p>B+ 树和红黑树比较：</p>
<ul>
<li>B+ 树一个节点可以存储多个元素，相较于红黑树树高更低，磁盘 IO 次数小</li>
<li>磁盘预读功能对 B+ 树产生优化功能</li>
</ul>
<p>B+ 树和 B 树比较：</p>
<ul>
<li>B+ 树磁盘 IO 更低，其内部节点全部是指针，没有实际数据，能够更快找到元素</li>
<li>B+ 树查询效率更加稳定</li>
<li>B+ 树遍历效率高</li>
</ul>
<p>MySQL 索引：在存储层实现，不同的存储引擎具有不同的索引类型</p>
<ul>
<li>B+ 树索引：主索引通常是聚簇索引，辅助索引通常需要回表，覆盖索引，组合索引</li>
<li>哈希索引：只支持点查询，不支持范围查询，同时不支持排序和分组操作</li>
<li>全文索引：用于查找文本中的关键词，通常采用倒排索引实现</li>
<li>空间数据索引（R-Tree）：多维索引，可用于存储地理数据</li>
</ul>
<p>索引优化：</p>
<ul>
<li>独立的列：查询条件中，索引列不能是表达式的一部分</li>
<li>多列索引：比单列索引更好</li>
<li>索引列顺序：让选择性强的索引放在前面</li>
<li>前缀索引</li>
<li>覆盖索引：索引包含所有需要查询的字段的值，不需要进行回表操作</li>
</ul>
<p>查询语句分析：使用 explain 进行分析，其结果参数</p>
<ul>
<li>select_type：常用的有 SIMPLE 简单查询，UNION 联合查询，SUBQUERY 子查询</li>
<li>possible_keys：可选择的索引</li>
<li>key：实际使用的索引</li>
<li>rows：扫描的行数</li>
<li>type：关联类型，决定通过什么方式找到每一行数据<ul>
<li>system：只有一条数据的系统表</li>
<li>const：主键或者唯一查询</li>
<li>eq_ref：在进行联接查询的，使用主键或者唯一索引并且只匹配到一行记录的时候</li>
<li>ref：使用非唯一索引</li>
<li>range：范围查询</li>
<li>index：跟全表扫描类似，只是扫表是按照索引顺序进行</li>
<li>all：全表扫描，不走索引</li>
</ul>
</li>
</ul>
<p>查询语句优化：</p>
<ul>
<li>减少请求的数据量，只返回必要的行数据和列数据</li>
<li>减少服务器扫描的行数，尽量通过覆盖索引</li>
<li>重构查询语句：切分大查询，分解大连接查询，将连接任务交给上层</li>
</ul>
<p>事务：</p>
<ul>
<li>特性：ACID</li>
<li>隔离级别：未提交读，提交读，可重复读，可串行化，快照</li>
<li>非一致性问题：脏读，不可重复读，幻读，丢失更新</li>
</ul>
<p>并发控制：</p>
<ul>
<li>锁：共享锁，排他锁，意向共享锁，意向排他锁</li>
<li>锁粒度：<ul>
<li>Record Lock：锁定一个记录对应的索引，而不是本身</li>
<li>Gap Lock：锁定索引之间的间隙，但是不包含索引本身</li>
<li>Next-Key Lock：左开右闭区间，Gap Lock + Record Lock</li>
</ul>
</li>
<li>MVCC：在每个记录后面加上两个隐藏的列，记录创建版本号和删除版本号，通过 undo 日志串联版本<ul>
<li>快照读：读取历史数据</li>
<li>当前读：读取数据库当前版本数据，可以通过加锁 <code>lock in share mode，for update</code> 实现</li>
</ul>
</li>
</ul>
<p>分库分表数据切分：水平切分（Sharding）和垂直切分</p>
<p>水平切分：</p>
<ul>
<li>策略：哈希取模，范围划分，映射表</li>
<li>问题：<ul>
<li>事务问题：改为分布式事务</li>
<li>连接：多个单表查询，在用户程序中连接</li>
<li>唯一性：使用全局唯一 GUID</li>
</ul>
</li>
</ul>
<p>MySQL 集群：</p>
<ul>
<li>主从复制：主要涉及三个线程，binglog 线程，IO 线程和 SQL 线程</li>
<li>读写分离：主服务器处理实时性要求高的读写操作，从服务器处理读操作，可以减轻主服务器的负载</li>
</ul>
<p>关系数据库设计范式：</p>
<ul>
<li>1NF：每个属性不可分割，可能存在数据冗余问题</li>
<li>2NF：消除非主属性对码的部分函数依赖</li>
<li>3NF：消除非主属性对于码的传递函数依赖，基本消除了各种异常</li>
<li>BCNF：主属性不依赖于主属性</li>
<li>4NF：消除多值依赖</li>
</ul>
<h2 id="02-MySQL-索引"><a href="#02-MySQL-索引" class="headerlink" title="02 MySQL 索引"></a>02 MySQL 索引</h2><p>索引的优缺点：</p>
<ul>
<li>优势：<ul>
<li>可以提高数据检索的速度，降低 IO 成本</li>
<li>索引还能对数据进行排序，降低排序查询语句的执行时间</li>
</ul>
</li>
<li>劣势：<ul>
<li>索引本身会占用部分空间</li>
<li>索引虽然提高了查询效率，但是降低了数据更新的效率，因为更新数据的同时需要更新数据</li>
</ul>
</li>
</ul>
<p>索引类型：主键索引，普通索引（辅助索引），唯一索引，全文索引，空间索引，前缀索引，单列索引，联合索引，聚簇索引</p>
<p>索引的数据结构：</p>
<ul>
<li>Hash 表：单点查询性能好，但是不支持范围查询</li>
<li>平衡二叉树：查询性能良好，但是树高太大，IO 次数多</li>
<li>B 树：改造二叉树，每个节点上有多个数据项，同时对应多个分支，中间节点上可以存储数据</li>
<li>B+ 树：只有叶子节点上存在数据，中间节点只有索引和节点值，进一步降低查找时的 IO 开销</li>
</ul>
<p>MyISAM 索引：索引和数据分开存储在不同的文件中，叶子节点记录的是磁盘地址</p>
<p>InnoDB 索引：叶子节点存储的数据是整行的数据，称之为聚簇索引，为此，普通索引需要进行回表操作</p>
<p>覆盖索引：在使用辅助索引的时候，需要经过回表操作才能拿到整行数据，可以创建组合索引避免回表</p>
<p>优化：</p>
<ul>
<li>避免回表：使用覆盖索引</li>
<li>正确使用联合索引，遵循最左匹配原则</li>
</ul>
<h2 id="03-组合索引的特殊情况"><a href="#03-组合索引的特殊情况" class="headerlink" title="03 组合索引的特殊情况"></a>03 组合索引的特殊情况</h2><p>假设存在表 t (a, b, c, d)，其中以 a 创建主键索引，以 (b, c, d) 创建组合索引，语句 <code>select * from t where c = 0</code> 执行过程中，有以下问题：</p>
<ul>
<li><p>上述条件查询并不满足最左匹配原则，为什么查询的时候使用了索引？</p>
<p>答：联合索引中有查询需要所有数据项，可以使用覆盖索引，但是其并不满足最左匹配，因此 type 是 index，而不是 ref，同时，组合索引中叶子节点信息量更大，主索引通常还包括了版本信息，事务 id，回流指针等等，因此选择组合索引</p>
</li>
<li><p>为这个表增加 e 字段后，上述查询为什么变为全表扫描？</p>
<p>答：加入 e 字段后，就不能使用覆盖索引了，此时就只能进行全表扫描</p>
</li>
</ul>
<h2 id="04-慢-SQL-查询语句"><a href="#04-慢-SQL-查询语句" class="headerlink" title="04 慢 SQL 查询语句"></a>04 慢 SQL 查询语句</h2><p>SQL 语句执行流程：</p>
<ul>
<li>连接器：服务器进行账户检查，权限检查等操作</li>
<li>缓存层</li>
<li>词法语法分析，检查 SQL 正确性</li>
<li>优化器找到最佳物理执行计划</li>
<li>调用存储引擎的相关接口进行查询，并返回结果</li>
</ul>
<p>InnoDB 存储引擎：</p>
<ul>
<li>磁盘预读机制：当引擎访问某个数据项的时候，通常其相邻的数据页也会被加载到内存</li>
<li>索引：InnoDB 主索引采用的是聚簇索引，如果没有唯一且非空的键则会隐式创建一个自增的列</li>
</ul>
<p>慢 SQL 危害：在高并发情况下，慢 SQL 出现后会阻塞大量正常的请求，造成大面积的超时和失败</p>
<p>慢 SQL 原因：</p>
<ul>
<li>索引创建方面：<ul>
<li>索引区分度低</li>
<li>切忌过多创建索引，其会大幅降低更新操作的效率</li>
<li>常用查询，排序，分组字段建索引</li>
<li>主键和外键建索引</li>
</ul>
</li>
<li>索引失效方面：<ul>
<li>对索引使用函数</li>
<li>对索引进行运算</li>
<li>对索引使用 &lt;&gt; 、not in 、not exist、!&#x3D;</li>
<li>对索引进行前导模糊查询</li>
<li>隐式转换会导致不走索引</li>
<li>非索引字段的 or 连接</li>
<li>非最左前缀</li>
</ul>
</li>
</ul>
<p>预防慢 SQL 方案：</p>
<ul>
<li>使用连接代替子查询</li>
<li>使用覆盖索引</li>
<li>多表关联查询时，小表在前，大表在后</li>
<li>调整 where 子句中的连接顺序</li>
<li>使用联合索引，而非建立多个单独索引</li>
</ul>
<p>慢 SQL 分析：打开慢 SQL 日志，设置慢 SQL 执行时间阈值，之后使用 explain 命令查看原因</p>
<h2 id="05-分页场景"><a href="#05-分页场景" class="headerlink" title="05 分页场景"></a>05 分页场景</h2><p>假设存在表 t_record (id, age, name)，id 上存在主索引，age 上存在辅助索引，下列语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_record <span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">offset</span> <span class="number">10000</span> limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>在第一次执行的时候很慢，在第二次有了缓存之后，才会变快。</p>
<p>对于 MySQL，上述语句会使用 age 上的索引，首先找到满足 age &gt; 10 的第一个数据，然后向后遍历 10000 项数据，并且对每一项数据，都会进行回表操作，即使我们不需要这些数据。这样的话引入了大量的随机 IO，自然速度变慢。</p>
<p>分页性能问题优化：</p>
<ul>
<li><p>产品上绕过，只提供上一页和下一页功能不需要回表，并且没有 offset</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_record <span class="keyword">where</span> id <span class="operator">&gt;</span> last_id  limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用覆盖索引：不需要进行额外的回表操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_record id <span class="keyword">in</span></span><br><span class="line">(<span class="keyword">select</span> id <span class="keyword">from</span> t_record <span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">offset</span> <span class="number">10000</span> limit <span class="number">10</span>）;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="06-MySQL-事务隔离性实现"><a href="#06-MySQL-事务隔离性实现" class="headerlink" title="06 MySQL 事务隔离性实现"></a>06 MySQL 事务隔离性实现</h2><p>事务特性：ACID</p>
<p>InnoDB 保证事务特性：</p>
<ul>
<li>持久性是通过 redo log （重做日志）来保证的</li>
<li>原子性是通过 undo log（回滚日志） 来保证的</li>
<li>隔离性是通过 MVCC（多版本并发控制） 和锁机制来保证的</li>
</ul>
<p>并行事务引发的问题：丢失更新，脏读，不可重复读，幻读</p>
<p>事务隔离性级别：未提交读，提交读，可重复读，串行化，快照隔离</p>
<p>InnoDB 保证事务隔离级别：</p>
<ul>
<li>未提交读：直接读取最新的数据</li>
<li>串行化：加读写锁实现</li>
<li>读提交和可重复读：通过 Read View 实现，读提交在每次读数据前生成一个 Read View，可重复读则在启动事务时生成一个 Read View，在之后都使用该 Read View</li>
</ul>
<p>MVCC 实现：在每个记录后面还增加了两个隐藏列，trx_id 和 roll_pointer，后者指向旧版本记录</p>
<p>Read View 数据结构：</p>
<p>![图片](《MYSQL》备忘录 &#x2F; 640-16462283919542.png)</p>
<p>可重复读：遍历记录版本，直到找到 trx_id 小于等于 creator_trx_id 的记录</p>
<p>读提交：遍历记录版本，直到找到 trx_id 小于 max_trx_id，并且其不在 m_ids 列表中的记录</p>
<h2 id="07-幻读的处理"><a href="#07-幻读的处理" class="headerlink" title="07 幻读的处理"></a>07 幻读的处理</h2><p>在可重复隔离级别下，普通的查询语句是快照读，其是不会看到别的事务插入的数据的，幻读的现象只能在当前读下产生。</p>
<p>InnoDB 为了防止该问题，采用了 next-key 锁，下面的事务 A 会锁住 <code>(2, +inf)</code> 范围的记录，如果该期间有其他事务在这个锁住的范围插入数据就会被阻塞，从而解决了幻读现象。</p>
<p>![图片](《MYSQL》备忘录 &#x2F; 640-16462307083174.png)</p>
<p>next-key 锁锁的是索引，而不是数据本身，如果 update 语句的 where 条件没有使用索引列，那么就会全表扫描，不仅加上行锁，还加上了间隙锁，相当于锁住整个表，直到事务结束时释放。因此，在线上千万不要执行没有带索引条件的 update 语句，不然会造成业务停滞。</p>
<h2 id="08-MySQL-中的锁"><a href="#08-MySQL-中的锁" class="headerlink" title="08 MySQL 中的锁"></a>08 MySQL 中的锁</h2><p>全局锁：</p>
<ul>
<li>使用方法：<code>flush tables with read lock</code> 和 <code>unlock tables</code> 加锁和解锁，加锁后整个数据库就只处于只读状态，会阻塞其他线程对表的结构和数据的更改</li>
<li>应用场景：全库逻辑备份，通常在不支持 MVCC 的引擎中使用，而对于像 InnoDB 引擎，可以在 mysqldump 时加上 <code>-single-transaction</code> 就能保证数据一致性</li>
<li>缺点：整个数据库只读状态，可能会造成业务停滞</li>
</ul>
<p>表级锁：</p>
<ul>
<li><p>表锁：<code>lock tables t_name read/write</code>，其会限制本线程和其他线程的读写操作</p>
</li>
<li><p>元数据锁（MDL）：不需要显式使用 MDL，其根据如下规则加锁：</p>
<ul>
<li>对一张表进行 CRUD 操作时，加的是 MDL 读锁</li>
<li>对一张表做结构变更操作的时候，加的是 MDL 写锁</li>
</ul>
<p>MDL 在事务提交后才会释放，另外，MDL 写锁获取的优先级高于读锁</p>
</li>
<li><p>意向锁：加锁规则如下：</p>
<ul>
<li>在对某些记录加上共享锁之前，需要先在表级别加上一个意向共享锁</li>
<li>在对某些纪录加上独占锁之前，需要先在表级别加上一个意向独占锁</li>
</ul>
<p>注意，普通的 select 是不会加锁的，因为其是利用 MVCC 实现，可以通过 <code>lock in share mode</code> 实现，意向共享锁和意向独占锁是表级锁，不会和行级的共享锁和独占锁发生冲突，而且意向锁之间也不会发生冲突，只会和共享表锁和独占表锁发生冲突，意向锁的目的是快速判断表里是否有记录被加锁</p>
</li>
<li><p>AUTO-INC 锁：该锁在执行完插入语句后就会释放，MySQL 5.2 后的版本提供了轻量级的锁，但是其在并发插入的时候，不能保证自增长的值是连续的，这在主从赋值的场景中是不安全的</p>
</li>
</ul>
<p>行级锁：InnoDB 才有，MyISAM 并没有行锁</p>
<ul>
<li>记录锁：锁住一条记录</li>
<li>间隙锁：锁定一个范围</li>
<li>Next-Key Lock：记录锁和间隙锁的组合，用左开右闭区间表示，是加锁的基本单位，但是可能会退化</li>
</ul>
<h2 id="09-MySQL-加锁规则"><a href="#09-MySQL-加锁规则" class="headerlink" title="09 MySQL 加锁规则"></a>09 MySQL 加锁规则</h2><p>唯一索引等值查询：</p>
<ul>
<li>查询的记录存在：退化成记录锁</li>
<li>查询的记录不存在：退化成间隙锁</li>
</ul>
<p>唯一索引范围查询：首先找到 min 对应的 next-key lock，如果 min 存在，退化成记录锁；最后找到 max 对应的 next-key lock，如果 max 不存在，退化成间隙锁</p>
<p>非唯一索引等值查询：</p>
<ul>
<li>查询的记录存在：先加 next-key lock， 另外一把锁退化成间隙锁</li>
<li>查询的记录不存在：退化成间隙锁</li>
</ul>
<p>非唯一索引范围查询：next-key lock 不会退化</p>
<h2 id="10-update-语句"><a href="#10-update-语句" class="headerlink" title="10 update 语句"></a>10 update 语句</h2><p>当执行 update 语句的时候，如果没有带上索引，可能会走全表扫描，从而导致全表加上了独占锁，导致业务停滞，通常可以使用以下方法避免该情况：</p>
<ul>
<li>开启安全更新模式，<code>sql_safe_update</code> 参数设置为 1，此时需要 update 有 where 或者 limit 子句</li>
<li>如果带上索引，但是优化器选择走全表扫描，可以使用 force index 语句</li>
</ul>
<h2 id="11-索引失效"><a href="#11-索引失效" class="headerlink" title="11 索引失效"></a>11 索引失效</h2><p>索引失效的情况：</p>
<ul>
<li>对索引使用左或者左右模糊匹配</li>
<li>对索引使用函数：MySQL 8.0 以后可以使用函数索引</li>
<li>对索引进行表达式计算</li>
<li>对索引隐式类型转换：在遇到字符串和数字比较的时候，会先把字符串转为数字，然后再进行比较</li>
<li>联合索引非最左匹配：(a, b, c) 组合索引，<code>where a = 6 and c = 8</code>，MySQL 5.6 之前版本会回表比较，而 之后的版本使用索引下推优化</li>
<li>WHERE 子句中的 OR</li>
</ul>
<h2 id="12-count-性能"><a href="#12-count-性能" class="headerlink" title="12 count 性能"></a>12 count 性能</h2><p>count 性能：count (*) &#x3D; count (1) &gt; count (主键字段) &gt; count (字段)</p>
<p>count 作用：统计符合查询条件的记录中，函数指定的参数不为 NULL 的记录有多少个</p>
<p>count (主键字段)：优先走二级索引，没有的话走主键索引，InnoDB 只会返回对应的主键字段</p>
<p>count (1)：和 count (主键字段) 类似，但是不会读取记录中的任何字段的值</p>
<p>count (*)：会被优化为 count (0)，执行效率和 count (1) 相同</p>
<p>count (字段)：会走全表扫描，如果其 NOT NULL，那么 Server 层就不需要额外的判断</p>
<blockquote>
<p>走聚簇索引和全表扫描的区别：全表扫描还需要额外访问叶子节点的非主键字段，效率更低</p>
</blockquote>
<p>MyISAM 引擎和 InnoDB 引擎：执行 count (*) 时，其直接返回表的元信息中 row_count 值，但是由于 InnoDB 支持 MVCC，并不能简单统计当前的行数作为业务的返回值，但当带上条件查询时，两者行为类似</p>
<p>如何优化 count (*)：</p>
<ul>
<li>使用近似值：如 explain</li>
<li>额外表保存计数值</li>
</ul>
<h2 id="13-MySQL-死锁避免"><a href="#13-MySQL-死锁避免" class="headerlink" title="13 MySQL 死锁避免"></a>13 MySQL 死锁避免</h2><p>多个客户端同时对资源加锁，就可能存在死锁现象，MySQL 中死锁避免方法有：</p>
<ul>
<li>设置事务等待锁的超时时间：innodb_lock_wait_timeout</li>
<li>开启主动死锁检测：innodb_deadlock_detect</li>
</ul>
<h2 id="14-MySQL-优化思路"><a href="#14-MySQL-优化思路" class="headerlink" title="14 MySQL 优化思路"></a>14 MySQL 优化思路</h2><p>MySQL 逻辑架构：</p>
<ul>
<li>客户端层：用于连接处理，授权认证，安全检测等</li>
<li>核心服务层：查询解析，分析，优化，缓存，跨存储引擎的功能在该层实现，如存储过程，触发器</li>
<li>存储引擎：负责 MySQL 中的数据存储和提取</li>
</ul>
<p>查询语句执行过程：</p>
<ul>
<li>客户端发送查询请求</li>
<li>检查缓存是否命中，命中直接返回，否则继续执行，可以设置 <code>query_cache_type</code> 为 DEAMND</li>
<li>解析、预处理、再由优化器生成对应的执行计划</li>
<li>根据执行计划，调用存储引擎的 API 来执行查询</li>
<li>将结果返回给客户端，该过程是一个增量且逐步返回的过程</li>
</ul>
<p>性能优化：</p>
<ul>
<li>Schema 设计和数据类型优化：通常越小的数据类型越快，占用更小的磁盘<ul>
<li>对整数类型指定宽度，没有任何作用</li>
<li>大多数情况下不使用枚举类型，因为添加和删除字符串必须使用 <code>alter table</code></li>
<li>schema 的列不要太多</li>
</ul>
</li>
<li>索引：<ul>
<li>注意索引失效的情况</li>
<li>前缀索引：如果列字符串很长，可以使用前缀索引</li>
<li>避免多个范围条件查询</li>
<li>覆盖索引</li>
<li>使用索引来排序</li>
<li>删除长期未使用的索引</li>
</ul>
</li>
<li>特定类型优化：<ul>
<li>优化 count 查询：直接使用 count (*)，如果不需要精确值，可以使用 explain</li>
<li>优化关联查询：可以使用子查询的方式来让优化器选择索引</li>
<li>优化 LIMIT 分页：使用覆盖索引，或者统计书签信息</li>
<li>优化 UNION：尽量使用 UNION ALL，否则的话需要做唯一性检查，该过程很耗时</li>
</ul>
</li>
</ul>
<h2 id="MySQL-面试题"><a href="#MySQL-面试题" class="headerlink" title="MySQL 面试题"></a>MySQL 面试题</h2><ul>
<li><p>能说下 MyISAM 和 InnoDB 的区别吗？</p>
<p>MyISAM 支持全文索引，压缩表和空间函数等，但是不支持事务和行级锁，通常用于大量查询少量插入的场景，MyISAM 的索引和数据是分开的；InnoDB 采用聚簇索引，其支持事务，外键和行级锁，并且通过 MVCC 来支持高并发。</p>
</li>
<li><p>说下 MySQL 的索引有哪些吧，聚簇和非聚簇索引又是什么？</p>
<p>索引按照数据结构来说主要分为 B+Tree 和哈希索引，聚簇索引是索引和数据存放在一起。</p>
</li>
<li><p>那你知道什么是覆盖索引和回表吗？</p>
<p>覆盖索引指的是通过索引就可以取到所需的数据，如果所需数据不能通过覆盖索引，就需要访问聚簇索引获取相应的数据，该行为称为回表。</p>
</li>
<li><p>锁的类型有哪些呢？</p>
<p>从粒度上，分为全局锁，表级锁，行锁；从加锁方式上，分为乐观锁和悲观锁；从是否共享，分为共享锁和排他锁。</p>
</li>
<li><p>你能说下事务的基本特性和隔离级别吗？</p>
<p>ACID，四种隔离级别分别消除了四种不一致现象。</p>
</li>
<li><p>那 ACID 靠什么保证的呢？</p>
<p>原子性通过 undolog 保证，隔离性通过 MVCC 和锁机制实现，持久性通过 redolog 实现，保证了事务的持久性、原子性、隔离性之后，一致性才能得到保障。</p>
</li>
<li><p>那你说说什么是幻读，什么是 MVCC？</p>
<p>幻读是指两次读取中读到了新插入的数据行，MVCC 实际上是为每个版本添加创建时间版本号，过期时间版本号，只有满足一定要求的事务才能读到对应的版本。</p>
</li>
<li><p>那你知道什么是 next-key lock 吗？</p>
<p>next-key lock 是 RR 下才有的锁，结合 MVCC 可以解决幻读的问题，其在一定条件下能够退化成记录锁或间隙锁。</p>
</li>
<li><p>你们数据量级多大？分库分表怎么做的？</p>
<p>一般拆分顺序是先垂直后水平，水平分库一般通过哈希取模实现，为提高性能，可以引入一致性哈希。</p>
</li>
<li><p>那分表后的自增 ID 怎么保证唯一性的呢？</p>
<p>设定不同步长，分布式 ID 如雪花算法，不使用自增主键而是使用其他唯一数据列作为主键。</p>
</li>
<li><p>分表后非 sharding_key 的查询怎么处理呢？</p>
<p>对实时性要求不高的话，可以建立宽表；数据量不是很大的话，可以多线程扫表，然后再聚合结果。</p>
</li>
<li><p>说说 mysql 主从同步怎么做的吧？</p>
<p>主服务器写入 binglog 后，会创建 dump 线程推送其到从服务器，从服务器启动 IO 线程读取推送过来的 binglog，记录到 relay log 中继日志中，从服务器开启一个 sql 线程读取 relay log 并且执行，最后从服务器也记录自己的 binlog。主从同步分为全同步复制和半同步复制，前者需要所有从库执行完才返回客户端，后者至少收到一个从库的 ack 即可。</p>
</li>
<li><p>那主从的延迟怎么解决呢？</p>
<p>并不能解决，但是能尽量优化，如尽量减少或者不使用长事务。</p>
</li>
<li><p>查询缓存的作用？</p>
<p>查询的时候先查询缓存，但是在 MySQL 8.0 后，该功能被移除。缓存虽然能够提升数据库的查询性能，但是缓存同时也带来了额外的开销，每次查询后都要做一次缓存操作，失效后还要销毁。建议设置 query_cache_type 变量为 DEMAND。</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://zsstrike.github.io">zsStrike</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://zsstrike.github.io/2022/03/02/%E3%80%8AMYSQL%E3%80%8B%E5%A4%87%E5%BF%98%E5%BD%95/">http://zsstrike.github.io/2022/03/02/《MYSQL》备忘录/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://zsstrike.github.io" target="_blank">zsStrike</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post_share"><div class="social-share" data-image="/assets/default_cover.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/assets/avatar.jpg" onerror="this.onerror=null;this.src='/assets/default_cover.png'" alt="avatar"/></div><div class="author-info__name">zsStrike</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/zsStrike"><i class="fab fa-github"></i><span>Github</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#01-MySQL-%E6%A6%82%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">01 MySQL 概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#02-MySQL-%E7%B4%A2%E5%BC%95"><span class="toc-number">2.</span> <span class="toc-text">02 MySQL 索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#03-%E7%BB%84%E5%90%88%E7%B4%A2%E5%BC%95%E7%9A%84%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5"><span class="toc-number">3.</span> <span class="toc-text">03 组合索引的特殊情况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#04-%E6%85%A2-SQL-%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5"><span class="toc-number">4.</span> <span class="toc-text">04 慢 SQL 查询语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#05-%E5%88%86%E9%A1%B5%E5%9C%BA%E6%99%AF"><span class="toc-number">5.</span> <span class="toc-text">05 分页场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#06-MySQL-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E6%80%A7%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">06 MySQL 事务隔离性实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#07-%E5%B9%BB%E8%AF%BB%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">07 幻读的处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#08-MySQL-%E4%B8%AD%E7%9A%84%E9%94%81"><span class="toc-number">8.</span> <span class="toc-text">08 MySQL 中的锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#09-MySQL-%E5%8A%A0%E9%94%81%E8%A7%84%E5%88%99"><span class="toc-number">9.</span> <span class="toc-text">09 MySQL 加锁规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-update-%E8%AF%AD%E5%8F%A5"><span class="toc-number">10.</span> <span class="toc-text">10 update 语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-number">11.</span> <span class="toc-text">11 索引失效</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-count-%E6%80%A7%E8%83%BD"><span class="toc-number">12.</span> <span class="toc-text">12 count 性能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-MySQL-%E6%AD%BB%E9%94%81%E9%81%BF%E5%85%8D"><span class="toc-number">13.</span> <span class="toc-text">13 MySQL 死锁避免</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-MySQL-%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="toc-number">14.</span> <span class="toc-text">14 MySQL 优化思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL-%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">15.</span> <span class="toc-text">MySQL 面试题</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2022 By zsStrike</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>